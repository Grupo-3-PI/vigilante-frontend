<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dashboard.css">
    <title>Vigilante | Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="icon" href="./images/icon-prevcrime-_1_.svg">

    <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessao(); carregarTabela()">

    <!-- Navbar -->
    <div class="container_navbar">
        <!-- Container cima -->
        <div class="container_top">
            <!-- Logo -->
            <div class="img_logo">
                <img src="./images/logo_vigilante.svg" alt="">
            </div>
            <!-- Botões da navbar -->
            <nav class="navbar_buttons">
                <!-- Botoes -->
                <a href="municipio.html" class="nav_item">
                    <i class='bx bx-home'></i>
                    <span>Home</span>
                </a>
                <a href="dashboard.html" class="nav_item" style="color: #34495e;">
                    <i class='bx bx-grid-alt'></i>
                    <span>Dashboard</span>
                </a>
                <a href="dicas.html" class="nav_item">
                    <i class='bx bx-bulb'></i>
                    <span>Dicas</span>
                </a>
            </nav>
        </div>
        <!-- Container baixo -->
        <div class="container_bottom">
            <div class="card_usuario">
                <div class="user_icon">
                    <i class='bx bx-user'></i>
                </div>
                <div class="user_info">
                    <span class="perfil">Admin</span>
                    <span class="nome">Luckinhas</span>
                    <span class="nome" id="b_usuario"></span>
                </div>
                <div class="notificacao">
                    <i class='bx bx-bell'></i>
                </div>
            </div>
            <button class="btn_gerenciar_usuario" onclick="window.location.href='gerenciadorUsuario.html'">Gerenciar usuários</button>
            <p class="copyright">©2025 PrevCrime, Inc.</p>
        </div>
    </div>

    <div id="fundo">
        <section id="relatorios">
            <h1 id="close-icon">X</h1>
            <h1 class="titulo-relatorio">Relatórios</h1>

            <div id="relatorio">
                <div class="relatorio-card">
                    <div class="relatorio-info">
                        <div class="relatorio-item">
                            <h3>nome do relatório</h3>
                            <p>01/05/2025 - 12:00:00</p>
                        </div>
                    </div>
                    <div class="relatorio-acoes">
                        <button class="acao editar"><i class="fa-regular fa-pen-to-square"></i></button>
                        <button class="acao excluir"><i class="fa-regular fa-trash-can"></i></button>
                        <button class="acao download"><i class="fa fa-download"></i></button>
                    </div>
                </div>

                <div class="relatorio-card">
                    <div class="relatorio-info">
                        <div class="relatorio-item">
                            <h3>nome do relatório</h3>
                            <p>01/04/2025 - 12:00:00</p>
                        </div>
                    </div>
                    <div class="relatorio-acoes">
                        <button class="acao editar"><i class="fa-regular fa-pen-to-square"></i></button>
                        <button class="acao excluir"><i class="fa-regular fa-trash-can"></i></button>
                        <button class="acao download"><i class="fa fa-download"></i></button>
                    </div>
                </div>

                <div class="relatorio-card">
                    <div class="relatorio-info">
                        <div class="relatorio-item">
                            <h3>nome do relatório</h3>
                            <p>01/03/2025 - 12:00:00</p>
                        </div>
                    </div>
                    <div class="relatorio-acoes">
                        <button class="acao editar"><i class="fa-regular fa-pen-to-square"></i></button>
                        <button class="acao excluir"><i class="fa-regular fa-trash-can"></i></button>
                        <button class="acao download"><i class="fa fa-download"></i></button>
                    </div>
                </div>

                <div class="relatorio-card">
                    <div class="relatorio-info">
                        <div class="relatorio-item">
                            <h3>nome do relatório</h3>
                            <p>01/02/2025 - 12:00:00</p>
                        </div>
                    </div>
                    <div class="relatorio-acoes">
                        <button class="acao editar"><i class="fa-regular fa-pen-to-square"></i></button>
                        <button class="acao excluir"><i class="fa-regular fa-trash-can"></i></button>
                        <button class="acao download"><i class="fa fa-download"></i></button>
                    </div>
                </div>

                <div class="relatorio-card">
                    <div class="relatorio-info">
                        <div class="relatorio-item">
                            <h3>nome do relatório</h3>
                            <p>01/01/2025 - 12:00:00</p>
                        </div>
                    </div>
                    <div class="relatorio-acoes">
                        <button class="acao editar"><i class="fa-regular fa-pen-to-square"></i></button>
                        <button class="acao excluir"><i class="fa-regular fa-trash-can"></i></button>
                        <button class="acao download"><i class="fa fa-download"></i></button>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <div class="conteudo">

        <div class="titulo">
            <div class="caminho">
                <a href="" class="caminho-tela">Tela Inicial</a> → <a href="" class="caminho-tela">Dashboard</a>
            </div>
        </div>

        <div class="dados">
            <div class="area-graficos">

                <div class="kpis">
                    <div class="kpi1 kpi">
                        <h3 class="kpi-titulo">Total de Crimes</span></h3>
                        <p class="kpi-valor1">12.359</p>
                    </div>
                    <div class="kpi2 kpi">
                        <h3 class="kpi-titulo">Total de Crimes em <span id="nomeMunicipioKPI">Bertioga</span></h3>
                        <p class="kpi-valor1" id="valorTotalCrimes">1.233</p>
                    </div>
                    <div class="kpi3 kpi">
                        <h3 class="kpi-titulo">Percentual de Alteração no Índice de Criminalidade (Último Mês)</h3>
                        <p class="kpi-valor2" id="percentualAlteracao">+3.5%</p>
                    </div>
                </div>

                <div class="graficos">
                    <div class="grafico1 grafico">
                        <canvas id="graficoCrimes"></canvas>
                    </div>
                    <div class="grafico2 grafico">
                        <canvas id="graficoPercentualMunicipios"></canvas>
                    </div>
                </div>

                <div class="area-grafico-produtividade">
                    <div class="atividade-policial"><canvas id="atividade-policial" width="490" height="125"></canvas>
                    </div>
                </div>

            </div>


            <div class="area-tabela">
                <div class="titulo-tabela">Ranking de Segurança dos Municípios</div>
                <div class="dados-tabela">
                    <table class="tabela" id="tabela">
                        <thead>
                            <tr>
                                <th></th>
                                <th style="padding-left: 15px;">Município</th>
                                <th style="padding-left: 10px;">Score</th>
                                <th style="padding-right: 5px;">Crimes</th>
                                <th style="padding-right: 10px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    const municipios = ["Bertioga", "Cubatão", "Guarujá", "Itanhaém", "Mongaguá", "Peruíbe", "Praia Grande", "Santos", "São Vicente"];
    var ano_selecionado = 2025;
    var municipio_selecionado = "Bertioga";

    // Preenche o nome do usuário na navbar
    if (sessionStorage.NOME_USUARIO) {
        document.getElementById('b_usuario').innerHTML = sessionStorage.NOME_USUARIO;
    }
    var idUsuario = Number(sessionStorage.ID_USUARIO);

    // Tabela
    // Provisório!!!
    function carregarTabela() {

        var valores_municipio = []

        municipios.forEach((municipio) => {

            var score = (Math.random() * 6 + 4).toFixed(1)
            var crimes = (Math.random() * 400 + 1000).toFixed()
            var status
            var seta
            if (score >= 7) {
                status = "<span style='color:rgb(0,128,0)'>Seguro</span>"
                seta = "<img src='./images/seta-up.png' class='imgSeta'/>"
            } else if (score >= 5) {
                status = "<span style='color:rgb(225, 225, 5)'>Moderado</span>"
                seta = "<img src='./images/seta-mid.png' class='imgSeta'/>"
            } else {
                status = "<span style='color:red'>Inseguro</red>"
                seta = "<img src='./images/seta-down.png' class='imgSeta'/>"
            }
            valores_municipio.push([`<tr class="linha-tabela"><td class="valor-tabela">${seta}</td><td class="valor-tabela">${municipio}</td><td class="valor-tabela">${score}</td><td class="valor-tabela">${crimes}</td><td class="valor-tabela">${status}</td></tr>`, score])
        })
        valores_municipio.sort((a, b) => b[1] - a[1]).forEach((municipio) => document.getElementById("corpo-tabela").innerHTML += municipio[0])
    }

    function exibirRelatorios() {
        document.getElementById("fundo").style.display = "flex";
        document.getElementById("relatorios").style.display = "block";
    }

    document.getElementById("close-icon").addEventListener("click", function () {
        document.getElementById("fundo").style.display = "none";
    });

    // Funções de filtro (exibirMunicipios, selecionarMunicipio, etc.) removidas do script 
    // pois os elementos não existem mais no HTML.

    // Atualizar KPI's
    function atualizarKPIs() {
        var alteracao = (Math.random() * 10 - 5).toFixed(1);

        document.getElementById("nomeMunicipioKPI").textContent = municipio_selecionado;
        document.getElementById("valorTotalCrimes").textContent = (Math.random() * 400 + 1000).toFixed()
        document.getElementById("percentualAlteracao").textContent = `${alteracao > 0 ? '+' : ''}${alteracao}%`

    }
    // Carrega os KPIs iniciais
    atualizarKPIs();

    //Gráfico de total de crimes
    const graficoTotalCrimes = new Chart(document.getElementById('graficoCrimes'), {
        type: 'bar',
        data: {
            labels: [
                'Contra a Vida',
                'Agressões Físicas',
                'Sexuais',
                'Contra o Patrimônio',
                'Outros'
            ],
            datasets: [{
                label: 'Número de Ocorrências',
                data: [180, 250, 90, 320, 70],
                backgroundColor: [
                    '#FFD8A8',
                    '#FFC078',
                    '#FFA94D',
                    '#FF922B',
                    '#E8590C'
                ],
                borderColor: '#fff',
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: '#eee'
                    },

                },
                y: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: `Distribuição dos Crimes por Tipo em ${municipio_selecionado} (${ano_selecionado})`,
                    color: 'black',
                    font: {
                        size: 14,
                        family: 'poppins',
                        weight: 450,
                    },
                    padding: {
                        top: 10,
                        bottom: 30
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return ` ${context.parsed.x} casos`;
                        }
                    }
                }
            }
        }
    });

    // Gráfico de percentual de criminalidade por município
    const ctxPercentual = document.getElementById('graficoPercentualMunicipios').getContext('2d');
    const graficoPercentualMunicipios = new Chart(ctxPercentual, {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [
                {
                    label: 'Bertioga',
                    data: [5.8],
                    backgroundColor: '#4e79a7',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'Cubatão',
                    data: [7.2],
                    backgroundColor: '#f28e2b',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'Guarujá',
                    data: [10.5],
                    backgroundColor: '#e15759',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'Itanhaém',
                    data: [6.4],
                    backgroundColor: '#76b7b2',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'Mongaguá',
                    data: [5.2],
                    backgroundColor: '#59a14f',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'Peruíbe',
                    data: [6.9],
                    backgroundColor: '#edc948',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'Praia Grande',
                    data: [13.8],
                    backgroundColor: '#b07aa1',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'Santos',
                    data: [28.4],
                    backgroundColor: '#ff9da7',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                },
                {
                    label: 'São Vicente',
                    data: [15.8],
                    backgroundColor: '#9c755f',
                    borderWidth: 1.5,
                    borderColor: '#fff',
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function (value) {
                            return value + '%';
                        },
                        font: {
                            family: 'Poppins'
                        }
                    },
                    grid: {
                        color: '#eee'
                    }
                },
                y: {
                    stacked: true,
                    grid: { display: false },
                    ticks: {
                        font: {
                            family: 'Poppins'
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Participação Percentual dos Crimes por Município (2025)',
                    color: '#000',
                    font: {
                        family: 'Poppins',
                        size: 14,
                        weight: 500
                    },
                    padding: {
                        top: 10,
                        bottom: 30
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            family: 'Poppins',
                            size: 11
                        },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return `${context.dataset.label}: ${context.raw}%`;
                        }
                    }
                }
            }
        }
    });


    // Gráfico de Atividade Policial
    const atividade_policial = new Chart(document.getElementById('atividade-policial').getContext('2d'), {
        type: 'line',
        data: {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
            datasets: [{
                label: 'Atividade Policial',
                borderWidth: 1.3,
                data: [(Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed(), (Math.random() * 400 + 1000).toFixed()],
                borderColor: 'blue',
                backgroundColor: 'transparent',
                tension: 0.3,
            },
            {
                label: 'Crimes',
                borderWidth: 1.3,
                data: [312, 875, 1040, 420, 1335, 605, 1210, 790, 1398, 910, 275, 1175],
                borderColor: 'orange',
                backgroundColor: 'transparent',
                tension: 0.3
            }]
        },
        plugins: [{
            id: 'tituloEsquerda',
            beforeDraw(chart) {
                const ctx = chart.ctx;
                ctx.save();
                ctx.font = '16px Poppins';
                ctx.textAlign = 'left';
                ctx.fillText(`Crimes por Produtividade Policial em ${municipio_selecionado} - ${ano_selecionado}`, chart.chartArea.left - 15, chart.chartArea.top - 40);
                ctx.restore();
            }
        }],
        options: {
            layout: {
                padding: {
                    top: 30,
                    bottom: 10,
                    left: 10,
                    right: 10
                }
            },
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        padding: 10
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    function atualizarAtividadePoilicial() {
        atividade_policial.data.datasets[0].data = [(Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed()]
        atividade_policial.data.datasets[1].data = [(Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed(), (Math.random() * 1200 + 200).toFixed()]

        atividade_policial.update()
    }
</script>